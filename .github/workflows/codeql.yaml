name: Security - CodeQL Analysis

on:
  push:
    branches:
      - main
      - dev**
  pull_request:
    branches:
      - main
      - dev**
  schedule:
    # Run CodeQL analysis on a schedule (daily at 2 AM UTC)
    - cron: '0 2 * * *'


jobs:
  codeql-analyze:
    name: Security / CodeQL
    uses: ./.github/workflows/core-codeql.yaml
    with:
      configuration: Release

  # This job aggregates CodeQL results for branch protection
  codeql-status-check:
    name: CodeQL Status
    runs-on: ubuntu-latest
    needs: codeql-analyze
    if: always()
    
    steps:
      - name: 'Aggregate: Check CodeQL results'
        run: |
          if [[ "${{ needs.codeql-analyze.result }}" != "success" ]]; then
            echo "::error::CodeQL analysis failed or found security issues"
            exit 1
          fi
          echo "âœ“ CodeQL analysis passed (via core workflow) - No critical security issues found"
        shell: bash
